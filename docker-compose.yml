services:
  # Substrate Node with custom pallet-shadow
  substrate-node:
    build:
      context: ./substrate-node
      dockerfile: Dockerfile
    container_name: shadowchain-substrate
    ports:
      - "9944:9944"     # WebSocket RPC
      - "9933:9933"     # HTTP RPC
      - "30333:30333"   # P2P
      - "9615:9615"     # Prometheus
    volumes:
      - substrate-data:/data
    command: >
      --dev
      --ws-external
      --rpc-external
      --rpc-cors all
      --base-path /data
      --name ShadowChain
    networks:
      - shadowchain

  # IPFS Node
  ipfs:
    image: ipfs/go-ipfs:latest
    container_name: shadowchain-ipfs
    ports:
      - "4001:4001"     # Swarm
      - "5001:5001"     # API
      - "8080:8080"     # Gateway
    volumes:
      - ipfs-data:/data/ipfs
    environment:
      - IPFS_PROFILE=server
      - IPFS_PATH=/data/ipfs
    networks:
      - shadowchain

  # Backend Service
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: shadowchain-backend
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - SUBSTRATE_WS=ws://substrate-node:9944
      - IPFS_API_URL=http://ipfs:5001
      - IPFS_GATEWAY_URL=http://ipfs:8080
      - PINNING_SERVICE=local
    env_file:
      - .env
    depends_on:
      - substrate-node
      - ipfs
    networks:
      - shadowchain
    restart: unless-stopped

  # Frontend
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    container_name: shadowchain-frontend
    ports:
      - "3000:80"
    environment:
      - REACT_APP_API_URL=http://localhost:3001
      - REACT_APP_WS_URL=ws://localhost:9944
      - REACT_APP_IPFS_GATEWAY=http://localhost:8080
    depends_on:
      - backend
    networks:
      - shadowchain

  # PostgreSQL (optional, for indexing)
  postgres:
    image: postgres:15-alpine
    container_name: shadowchain-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=shadowchain
      - POSTGRES_PASSWORD=shadowchain
      - POSTGRES_DB=shadowchain
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - shadowchain
    profiles:
      - with-db

  # Redis (optional, for caching)
  redis:
    image: redis:7-alpine
    container_name: shadowchain-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - shadowchain
    profiles:
      - with-cache

volumes:
  substrate-data:
  ipfs-data:
  postgres-data:
  redis-data:

networks:
  shadowchain:
    driver: bridge