{"ast":null,"code":"import { map, of } from 'rxjs';\nimport { memo } from '../util/index.js';\nimport { getEraCache, setEraCache } from './cache.js';\nimport { combineEras, erasHistoricApply, singleEra } from './util.js';\nconst CACHE_KEY = 'eraExposure';\nfunction mapStakersClipped(era, stakers) {\n  const nominators = {};\n  const validators = {};\n  stakers.forEach(([key, exposure]) => {\n    const validatorId = key.args[1].toString();\n    validators[validatorId] = exposure;\n    exposure.others.forEach(({\n      who\n    }, validatorIndex) => {\n      const nominatorId = who.toString();\n      nominators[nominatorId] = nominators[nominatorId] || [];\n      nominators[nominatorId].push({\n        validatorId,\n        validatorIndex\n      });\n    });\n  });\n  return {\n    era,\n    nominators,\n    validators\n  };\n}\nfunction mapStakersPaged(era, stakers) {\n  const nominators = {};\n  const validators = {};\n  stakers.forEach(([key, exposureOpt]) => {\n    if (exposureOpt.isSome) {\n      const validatorId = key.args[1].toString();\n      const exposure = exposureOpt.unwrap();\n      validators[validatorId] = exposure;\n      exposure.others.forEach(({\n        who\n      }, validatorIndex) => {\n        const nominatorId = who.toString();\n        nominators[nominatorId] = nominators[nominatorId] || [];\n        nominators[nominatorId].push({\n          validatorId,\n          validatorIndex\n        });\n      });\n    }\n  });\n  return {\n    era,\n    nominators,\n    validators\n  };\n}\n/**\n * erasStakersClipped will be deprecated and replaced with erasStakersPaged. Therefore support is given for both\n * storage queries until erasStakersClipped has been completely out of use.\n */\nexport function _eraExposure(instanceId, api) {\n  return memo(instanceId, (era, withActive = false) => {\n    const [cacheKey, cached] = getEraCache(CACHE_KEY, era, withActive);\n    return cached ? of(cached) : api.query.staking.erasStakersPaged ? api.query.staking.erasStakersPaged.entries(era).pipe(map(r => setEraCache(cacheKey, withActive, mapStakersPaged(era, r)))) : api.query.staking.erasStakersClipped.entries(era).pipe(map(r => setEraCache(cacheKey, withActive, mapStakersClipped(era, r))));\n  });\n}\nexport const eraExposure = /*#__PURE__*/singleEra('_eraExposure');\nexport const _erasExposure = /*#__PURE__*/combineEras('_eraExposure');\nexport const erasExposure = /*#__PURE__*/erasHistoricApply('_erasExposure');","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}