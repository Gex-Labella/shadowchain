{"ast":null,"code":"import { combineLatest, map, of, switchMap } from 'rxjs';\nimport { objectSpread } from '@polkadot/util';\nimport { memo } from '../util/index.js';\nfunction withProgressField(field) {\n  return (instanceId, api) => memo(instanceId, () => api.derive.session.progress().pipe(map(info => info[field])));\n}\nfunction createDerive(api, info, [currentSlot, epochIndex, epochOrGenesisStartSlot, activeEraStartSessionIndex]) {\n  const epochStartSlot = epochIndex.mul(info.sessionLength).iadd(epochOrGenesisStartSlot);\n  const sessionProgress = currentSlot.sub(epochStartSlot);\n  const eraProgress = info.currentIndex.sub(activeEraStartSessionIndex).imul(info.sessionLength).iadd(sessionProgress);\n  return objectSpread({\n    eraProgress: api.registry.createType('BlockNumber', eraProgress),\n    sessionProgress: api.registry.createType('BlockNumber', sessionProgress)\n  }, info);\n}\nfunction queryAura(api) {\n  return api.derive.session.info().pipe(map(info => objectSpread({\n    eraProgress: api.registry.createType('BlockNumber'),\n    sessionProgress: api.registry.createType('BlockNumber')\n  }, info)));\n}\nfunction queryBabe(api) {\n  return api.derive.session.info().pipe(switchMap(info => combineLatest([of(info),\n  // we may have no staking, but have babe (permissioned)\n  api.query.staking?.erasStartSessionIndex ? api.queryMulti([api.query.babe.currentSlot, api.query.babe.epochIndex, api.query.babe.genesisSlot, [api.query.staking.erasStartSessionIndex, info.activeEra]]) : api.queryMulti([api.query.babe.currentSlot, api.query.babe.epochIndex, api.query.babe.genesisSlot])])), map(([info, [currentSlot, epochIndex, genesisSlot, optStartIndex]]) => [info, [currentSlot, epochIndex, genesisSlot, optStartIndex && optStartIndex.isSome ? optStartIndex.unwrap() : api.registry.createType('SessionIndex', 1)]]));\n}\n/**\n * @description Retrieves all the session and era query and calculates specific values on it as the length of the session and eras\n */\nexport function progress(instanceId, api) {\n  return memo(instanceId, () => api.query.babe ? queryBabe(api).pipe(map(([info, slots]) => createDerive(api, info, slots))) : queryAura(api));\n}\nexport const eraLength = /*#__PURE__*/withProgressField('eraLength');\nexport const eraProgress = /*#__PURE__*/withProgressField('eraProgress');\nexport const sessionProgress = /*#__PURE__*/withProgressField('sessionProgress');","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}